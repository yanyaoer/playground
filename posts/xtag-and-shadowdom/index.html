<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>xtag-and-shadowdom - yányào.com</title><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="xtag-and-shadowdom"><meta property="og:description" content="最近在做的项目重构, 原本打算用 reactjs, 写了一些实验代码后心累无爱 找了个 domdiff 配合自定义标签和 shadowdom 的独有作用域也是爽 YY
可惜的是测试红米上的 android webview 版本(32?)不支持 ::shadow 伪类 inline 方式覆盖样式略嫌繁琐
示例代码 xtag.js let dom = { shadow(el) { return el.createShadowRoot ? el.createShadowRoot() : el.webkitCreateShadowRoot(); }, attr(el, prefix='') { return Object.keys(el.dataset).map((d)=> `${prefix}${d}=&#34;${el.dataset[d]}&#34;`).join(' ') } } document.registerElement('x-image', { prototype: Object.create(HTMLElement.prototype, { createdCallback: { value() { //xtag 嵌套时这里读不到attr, 放到 attach  console.log('onCreate::image'); } }, attachedCallback: { value() { console.log('onAttach::image'); let shadow = dom.shadow(this); shadow.innerHTML = `<style> img { max-width: 100%; } </style> <img ${dom."><meta property="og:type" content="article"><meta property="og:url" content="http://y%C3%A1ny%C3%A0o.com/posts/xtag-and-shadowdom/"><meta property="article:published_time" content="2015-10-04T12:20:52+00:00"><meta property="article:modified_time" content="2015-10-04T12:20:52+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="xtag-and-shadowdom"><meta name=twitter:description content="最近在做的项目重构, 原本打算用 reactjs, 写了一些实验代码后心累无爱 找了个 domdiff 配合自定义标签和 shadowdom 的独有作用域也是爽 YY
可惜的是测试红米上的 android webview 版本(32?)不支持 ::shadow 伪类 inline 方式覆盖样式略嫌繁琐
示例代码 xtag.js let dom = { shadow(el) { return el.createShadowRoot ? el.createShadowRoot() : el.webkitCreateShadowRoot(); }, attr(el, prefix='') { return Object.keys(el.dataset).map((d)=> `${prefix}${d}=&#34;${el.dataset[d]}&#34;`).join(' ') } } document.registerElement('x-image', { prototype: Object.create(HTMLElement.prototype, { createdCallback: { value() { //xtag 嵌套时这里读不到attr, 放到 attach  console.log('onCreate::image'); } }, attachedCallback: { value() { console.log('onAttach::image'); let shadow = dom.shadow(this); shadow.innerHTML = `<style> img { max-width: 100%; } </style> <img ${dom."><link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=http://y%C3%A1ny%C3%A0o.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=http://y%C3%A1ny%C3%A0o.com/css/main.css><script src=http://y%C3%A1ny%C3%A0o.com/js/main.js></script></head><body><div class="container wrapper post"><div class=header><h1 class=site-title><a href=http://y%C3%A1ny%C3%A0o.com/>yányào.com</a></h1><div class=site-description><nav class="nav social"><ul class=flat></ul></nav></div><nav class=nav><ul class=flat></ul></nav></div><div class=post-header><h1 class=title>xtag-and-shadowdom</h1><div class=meta>Posted at &mdash; Oct 4, 2015</div></div><div class=markdown><p>最近在做的项目重构, 原本打算用 reactjs, 写了一些实验代码后心累无爱
找了个 domdiff 配合自定义标签和 shadowdom 的独有作用域也是爽 YY</p><p>可惜的是测试红米上的 android webview 版本(32?)不支持 ::shadow 伪类
inline 方式覆盖样式略嫌繁琐</p><h2 id=示例代码>示例代码</h2><h3 id=xtagjs>xtag.js</h3><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#268bd2>let</span> dom <span style=color:#719e07>=</span> {
  shadow(el) {
    <span style=color:#719e07>return</span> el.createShadowRoot <span style=color:#719e07>?</span> el.createShadowRoot() <span style=color:#719e07>:</span> el.webkitCreateShadowRoot();
  },
  attr(el, prefix<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;&#39;</span>) {
    <span style=color:#719e07>return</span> <span style=color:#b58900>Object</span>.keys(el.dataset).map((d)=&gt; <span style=color:#586e75>`</span><span style=color:#2aa198>${</span>prefix<span style=color:#2aa198>}${</span>d<span style=color:#2aa198>}</span><span style=color:#586e75>=&#34;</span><span style=color:#2aa198>${</span>el.dataset[d]<span style=color:#2aa198>}</span><span style=color:#586e75>&#34;`</span>).join(<span style=color:#2aa198>&#39; &#39;</span>)
  }
}

<span style=color:#b58900>document</span>.registerElement(<span style=color:#2aa198>&#39;x-image&#39;</span>, {
  prototype<span style=color:#719e07>:</span> <span style=color:#b58900>Object</span>.create(HTMLElement.prototype, {
    createdCallback<span style=color:#719e07>:</span> {
      value() {
        <span style=color:#586e75>//xtag 嵌套时这里读不到attr, 放到 attach
</span><span style=color:#586e75></span>        console.log(<span style=color:#2aa198>&#39;onCreate::image&#39;</span>);
      }
    },
    attachedCallback<span style=color:#719e07>:</span> {
      value() {
        console.log(<span style=color:#2aa198>&#39;onAttach::image&#39;</span>);
        <span style=color:#268bd2>let</span> shadow <span style=color:#719e07>=</span> dom.shadow(<span style=color:#719e07>this</span>);
        shadow.innerHTML <span style=color:#719e07>=</span> <span style=color:#586e75>`&lt;style&gt;
</span><span style=color:#586e75>            img { max-width: 100%; }
</span><span style=color:#586e75>          &lt;/style&gt;
</span><span style=color:#586e75>          &lt;img </span><span style=color:#2aa198>${</span>dom.attr(<span style=color:#719e07>this</span>)<span style=color:#2aa198>}</span><span style=color:#586e75> /&gt;`</span>;

        <span style=color:#719e07>this</span>.onclick <span style=color:#719e07>=</span> (e) =&gt; {
          console.log(<span style=color:#719e07>this</span>);
        }
      }
    }
  })
});

<span style=color:#586e75>// other x-tag;
</span></code></pre></div><h3 id=indexjs>index.js</h3><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#268bd2>import</span> <span style=color:#2aa198>&#39;babel/polyfill&#39;</span>;
<span style=color:#268bd2>import</span> <span style=color:#2aa198>&#39;./xtag.js&#39;</span>;

<span style=color:#268bd2>class</span> BaseView {
  constructor(opt) {
    <span style=color:#b58900>Object</span>.assign(<span style=color:#719e07>this</span>, {
      root<span style=color:#719e07>:</span> dom(<span style=color:#2aa198>&#39;#app&#39;</span>)
    }, opt);
  }
  mount() {
    console.log(<span style=color:#2aa198>&#39;event::mount&#39;</span>);
  }
  onCreate() {
    console.log(<span style=color:#2aa198>&#39;event::create&#39;</span>);
  }
  onUpdate() {
    console.log(<span style=color:#2aa198>&#39;event::update&#39;</span>);
  }
}

<span style=color:#268bd2>export</span> <span style=color:#719e07>default</span> <span style=color:#268bd2>class</span> BannerView <span style=color:#268bd2>extends</span> BaseView {
  init(...args) {
    <span style=color:#719e07>this</span>.mount(...args);
  }
  render() {
    <span style=color:#719e07>return</span> <span style=color:#586e75>`&lt;x-image data-src=&#34;</span><span style=color:#2aa198>${</span><span style=color:#719e07>this</span>.src<span style=color:#2aa198>}</span><span style=color:#586e75>&#34;
</span><span style=color:#586e75>                     data-href=&#34;</span><span style=color:#2aa198>${</span><span style=color:#719e07>this</span>.redirect_url<span style=color:#2aa198>}</span><span style=color:#586e75>&#34; /&gt;`</span>;
  }
}
</code></pre></div><h2 id=links>links</h2><p><a href=http://www.html5rocks.com/en/tutorials/webcomponents/customelements/>http://www.html5rocks.com/en/tutorials/webcomponents/customelements/</a>
<a href=http://www.html5rocks.com/en/tutorials/webcomponents/shadowdom-301/>http://www.html5rocks.com/en/tutorials/webcomponents/shadowdom-301/</a></p></div><div class=post-tags></div><script src=https://utteranc.es/client.js repo=yanyaoer/yanyaoer.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></div><div class="footer wrapper"><nav class=nav><div><a href=https://github.com/vividvilla/ezhil>Ezhil theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></nav></div></body></html>