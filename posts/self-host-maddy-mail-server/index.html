<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Self Host Maddy Mail Server - yányào.com</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:title" content="Self Host Maddy Mail Server"><meta property="og:description" content="maddy Composable all-in-one mail server. https://github.com/foxcpp/maddy
准备自建系列服务替换掉 google 全家桶，先试了传统的 Postfix, Dovecot, OpenDKIM, OpenSPF, OpenDMARC 套餐，但是本人水平菜，机器配置也不高，折腾两天还没跑起来，正好看到订阅的 changelog 推荐了 maddy 1 于是搓搓手气试试这个邮局方案，以下是满足个人喜好的优点
基于 golang 生态依赖少，方便打镜像 验证数据存在 sqlite 里也很轻量 没有 web 端，只需要 imap + thunderbird 即可 配置文件相对简单 install mkdir -p /data/maddy # hard link caddy's crt and key to maddy ln var/lib/caddy/.local/share/caddy/certificates/acme-v02.api.letsencrypt.org-directory/${domain}/${domain}.crt /data/maddy/${domain}.crt ln var/lib/caddy/.local/share/caddy/certificates/acme-v02.api.letsencrypt.org-directory/${domain}/${domain}.key /data/maddy/${domain}.key # foxcpp/maddy:v0.4.2 podman run \ --name maddy \ -v /data/maddy:/data \ -p 25:25 \ -p 143:143 \ -p 587:587 \ -p 993:993 \ -p 465:465 \ yanyaoer/maddy:master # add user podman run --rm -it -v /data/maddy:/data --entrypoint /bin/maddyctl yanyaoer/maddy:master creds create yanyao@mail."><meta property="og:type" content="article"><meta property="og:url" content="https://y%C3%A1ny%C3%A0o.com/posts/self-host-maddy-mail-server/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-12-01T20:34:44+08:00"><meta property="article:modified_time" content="2020-12-01T20:34:44+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Self Host Maddy Mail Server"><meta name=twitter:description content="maddy Composable all-in-one mail server. https://github.com/foxcpp/maddy
准备自建系列服务替换掉 google 全家桶，先试了传统的 Postfix, Dovecot, OpenDKIM, OpenSPF, OpenDMARC 套餐，但是本人水平菜，机器配置也不高，折腾两天还没跑起来，正好看到订阅的 changelog 推荐了 maddy 1 于是搓搓手气试试这个邮局方案，以下是满足个人喜好的优点
基于 golang 生态依赖少，方便打镜像 验证数据存在 sqlite 里也很轻量 没有 web 端，只需要 imap + thunderbird 即可 配置文件相对简单 install mkdir -p /data/maddy # hard link caddy's crt and key to maddy ln var/lib/caddy/.local/share/caddy/certificates/acme-v02.api.letsencrypt.org-directory/${domain}/${domain}.crt /data/maddy/${domain}.crt ln var/lib/caddy/.local/share/caddy/certificates/acme-v02.api.letsencrypt.org-directory/${domain}/${domain}.key /data/maddy/${domain}.key # foxcpp/maddy:v0.4.2 podman run \ --name maddy \ -v /data/maddy:/data \ -p 25:25 \ -p 143:143 \ -p 587:587 \ -p 993:993 \ -p 465:465 \ yanyaoer/maddy:master # add user podman run --rm -it -v /data/maddy:/data --entrypoint /bin/maddyctl yanyaoer/maddy:master creds create yanyao@mail."><link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://y%C3%A1ny%C3%A0o.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://y%C3%A1ny%C3%A0o.com/css/main.css><script src=https://y%C3%A1ny%C3%A0o.com/js/feather.min.js></script><script src=https://y%C3%A1ny%C3%A0o.com/js/main.js></script></head><body><div class="container wrapper post"><div class=header><base href=https://y%C3%A1ny%C3%A0o.com/><h1 class=site-title><a href=https://y%C3%A1ny%C3%A0o.com/>yányào.com</a></h1><div class=site-description><h2>looking a wood sprite in the forest</h2><nav class="nav social"><ul class=flat><a href=/index.xml title=RSS><i data-feather=rss></i></a><a href=/daydayup/ title=Status><i data-feather=activity></i></a><a href=https://yankuiyi.com/ title=microfeed><i data-feather=radio></i></a><a href=https://fouland.com/ title=Logseq><i data-feather=inbox></i></a><a href=https://at.yadanhe.com/ title=Mastodon><i data-feather=at-sign></i></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li></ul></nav></div><div class=post-header><h1 class=title>Self Host Maddy Mail Server</h1><div class=meta>Posted at &mdash; Dec 1, 2020</div></div><div class=markdown><h2 id=maddy>maddy</h2><blockquote><p>Composable all-in-one mail server. <a href=https://github.com/foxcpp/maddy>https://github.com/foxcpp/maddy</a></p></blockquote><p>准备自建系列服务替换掉 google 全家桶，先试了传统的 Postfix, Dovecot, OpenDKIM, OpenSPF, OpenDMARC 套餐，但是本人水平菜，机器配置也不高，折腾两天还没跑起来，正好看到订阅的 changelog 推荐了 maddy <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> 于是搓搓手气试试这个邮局方案，以下是满足个人喜好的优点</p><ul><li>基于 golang 生态依赖少，方便打镜像</li><li>验证数据存在 sqlite 里也很轻量</li><li>没有 web 端，只需要 imap + thunderbird 即可</li><li>配置文件相对简单</li></ul><h2 id=install>install</h2><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /data/maddy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># hard link caddy&#39;s crt and key to maddy</span>
</span></span><span style=display:flex><span>ln var/lib/caddy/.local/share/caddy/certificates/acme-v02.api.letsencrypt.org-directory/<span style=color:#2aa198>${</span><span style=color:#268bd2>domain</span><span style=color:#2aa198>}</span>/<span style=color:#2aa198>${</span><span style=color:#268bd2>domain</span><span style=color:#2aa198>}</span>.crt /data/maddy/<span style=color:#2aa198>${</span><span style=color:#268bd2>domain</span><span style=color:#2aa198>}</span>.crt
</span></span><span style=display:flex><span>ln var/lib/caddy/.local/share/caddy/certificates/acme-v02.api.letsencrypt.org-directory/<span style=color:#2aa198>${</span><span style=color:#268bd2>domain</span><span style=color:#2aa198>}</span>/<span style=color:#2aa198>${</span><span style=color:#268bd2>domain</span><span style=color:#2aa198>}</span>.key /data/maddy/<span style=color:#2aa198>${</span><span style=color:#268bd2>domain</span><span style=color:#2aa198>}</span>.key
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># foxcpp/maddy:v0.4.2</span>
</span></span><span style=display:flex><span>podman run <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  --name maddy <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  -v /data/maddy:/data <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  -p 25:25 <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  -p 143:143 <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  -p 587:587 <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  -p 993:993 <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  -p 465:465 <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  yanyaoer/maddy:master
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># add user</span>
</span></span><span style=display:flex><span>podman run --rm -it -v /data/maddy:/data --entrypoint /bin/maddyctl yanyaoer/maddy:master creds create yanyao@mail.yadanhe.com
</span></span></code></pre></div><p>参考文档配置<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> 完后发送邮件对方可收，本地 thunderbird 接收回复邮件时有问题</p><ul><li><input checked disabled type=checkbox> spf 验证无法通过，暂时禁用待修复</li><li><input checked disabled type=checkbox> 接收时报错 &ldquo;Unexpected EOF when reciving from Steam&rdquo;，等 0.4.3 发布 <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></li></ul><h2 id=workaround>workaround</h2><ul><li>使用 master 分支打包镜像 maddy 0.5.0-dev15+ge4ad3bd 到 <code>yanyaoer/maddy:master</code> 临时使用</li><li>go 1.15.5 打包镜像时报错 <code>go build runtime/cgo: invalid flag in go:cgo_ldflag: -Wl,-z,relro,-z,now</code>，在 builds.sh 里添加参数通过 <sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup></li></ul><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>diff <span style=color:#719e07>--</span>git a<span style=color:#719e07>/</span>build<span style=color:#719e07>.</span>sh b<span style=color:#719e07>/</span>build<span style=color:#719e07>.</span>sh
</span></span><span style=display:flex><span>index a76f6b6<span style=color:#719e07>..</span>b6e2eb2 <span style=color:#2aa198>100755</span>
</span></span><span style=display:flex><span><span style=color:#719e07>---</span> a<span style=color:#719e07>/</span>build<span style=color:#719e07>.</span>sh
</span></span><span style=display:flex><span><span style=color:#719e07>+++</span> b<span style=color:#719e07>/</span>build<span style=color:#719e07>.</span>sh
</span></span><span style=display:flex><span>@@ <span style=color:#719e07>-</span><span style=color:#2aa198>119</span>,<span style=color:#2aa198>6</span> <span style=color:#719e07>+</span><span style=color:#2aa198>119</span>,<span style=color:#2aa198>7</span> @@ read_config() {
</span></span><span style=display:flex><span>         <span style=color:#719e07>export</span> MADDY_SRC<span style=color:#719e07>=</span>
</span></span><span style=display:flex><span>     fi
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>+</span>    <span style=color:#719e07>export</span> CGO_LDFLAGS_ALLOW<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;-Wl,-z,relro,-z,now&#39;</span>
</span></span><span style=display:flex><span>     <span style=color:#719e07>export</span> CGO_CFLAGS<span style=color:#719e07>=</span><span style=color:#2aa198>&#34;-g -O2 -D_FORTIFY_SOURCE=2 $CFLAGS&#34;</span>
</span></span><span style=display:flex><span>     <span style=color:#719e07>export</span> CGO_CXXFLAGS<span style=color:#719e07>=</span><span style=color:#2aa198>&#34;-g -O2 -D_FORTIFY_SOURCE=2 $CXXFLAGS&#34;</span>
</span></span><span style=display:flex><span>     <span style=color:#719e07>export</span> LDFLAGS<span style=color:#719e07>=</span><span style=color:#2aa198>&#34;-Wl,-z,relro,-z,now $LDFLAGS&#34;</span>
</span></span></code></pre></div><p>** update: 2021-07-23 **
<a href=https://github.com/foxcpp/maddy/releases/tag/v0.4.4>v0.4.4</a>
直接下载解压以上功能正常使用，不再使用 podman 部署</p><h2 id=alternative>alternative</h2><p>以下方案不太合口味，日后有缘再试</p><ul><li><a href=https://github.com/sovereign/sovereign>https://github.com/sovereign/sovereign</a></li><li><a href=https://github.com/ajgon/self-hosted-mailserver/blob/master/docs/nsa-proof-your-e-mail-in-2-hours.md>https://github.com/ajgon/self-hosted-mailserver/blob/master/docs/nsa-proof-your-e-mail-in-2-hours.md</a></li><li><a href=https://github.com/Mailu/Mailu>https://github.com/Mailu/Mailu</a></li><li><a href=https://github.com/mailcow/mailcow-dockerized>https://github.com/mailcow/mailcow-dockerized</a></li><li><a href=https://github.com/tonioo/modoboa>https://github.com/tonioo/modoboa</a></li><li><a href=https://github.com/sovereign/sovereign>https://github.com/sovereign/sovereign</a></li><li><a href=https://github.com/mail-in-a-box/mailinabox>https://github.com/mail-in-a-box/mailinabox</a></li><li><a href=https://github.com/iredmail/iRedMail>https://github.com/iredmail/iRedMail</a></li></ul><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://changelog.com/news/maddy-a-composable-allinone-mail-server-ljEe>https://changelog.com/news/maddy-a-composable-allinone-mail-server-ljEe</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://foxcpp.dev/maddy/tutorials/setting-up/>https://foxcpp.dev/maddy/tutorials/setting-up/</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://github.com/foxcpp/maddy/issues/300>https://github.com/foxcpp/maddy/issues/300</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://github.com/foxcpp/maddy/issues/299#issuecomment-735862091>https://github.com/foxcpp/maddy/issues/299#issuecomment-735862091</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=post-tags><nav class="nav tags"><ul class=flat><li><a href=/tags/self-host>self-host</a></li><li><a href=/tags/mail-server>mail-server</a></li><li><a href=/tags/maddy>maddy</a></li><li><a href=/tags/degoogle>degoogle</a></li></ul></nav></div></div><div class="footer wrapper"><nav class=nav><div><a href=https://github.com/vividvilla/ezhil>Ezhil theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></nav></div><script>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-LYFRPQF0H9","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script><script>feather.replace()</script></body></html>