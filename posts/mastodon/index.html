<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Mastodon - yányào.com</title><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="Mastodon"><meta property="og:description" content="Mastodon 长毛象1 &ndash; 基于 rubyonrails/reactjs/nodejs 开发的分布式 & 去中心化 twiter clone。利用空闲时间在 aws lightsail 上开了个实例把服务跑了起来
一开始走了些弯路，因为选机房和省钱的缘故，重建了若干次操作系统，最后的选择是 tokyo+cloudflare，没错我又套了 cdn，实在是海外线路到北京联通不稳定
安装步骤没有使用 docker 而是参考文档从源码安装2，原因和解决方案如下：
机器用 $3.5/mo 512mem 最便宜的那档消费降级(512M 内存重启会拉垮弱鸡，服务已迁移到 oraclecloud)，出于 net/io 性能考虑就不使 docker 啦
内存问题，RAILS_ENV=production bundle exec rake mastodon:setup 这一步骤执行到 rails assets:precompile， 不管是在 docker 里跑还是直接运行都会报 swap 分区不足，找到两个方案来解决:
# create swapfile <https://linuxize.com/post/create-a-linux-swap-file/> $ sudo fallocate -l 2G /swapfile $ sudo chmod 600 /swapfile $ sudo mkswap /swapfile $ sudo swapon /swapfile # verify active $ sudo swapon --show # optional: low value is better for production $ sudo sysctl vm."><meta property="og:type" content="article"><meta property="og:url" content="https://y%C3%A1ny%C3%A0o.com/posts/mastodon/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-05-15T09:45:08+08:00"><meta property="article:modified_time" content="2020-05-15T09:45:08+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Mastodon"><meta name=twitter:description content="Mastodon 长毛象1 &ndash; 基于 rubyonrails/reactjs/nodejs 开发的分布式 & 去中心化 twiter clone。利用空闲时间在 aws lightsail 上开了个实例把服务跑了起来
一开始走了些弯路，因为选机房和省钱的缘故，重建了若干次操作系统，最后的选择是 tokyo+cloudflare，没错我又套了 cdn，实在是海外线路到北京联通不稳定
安装步骤没有使用 docker 而是参考文档从源码安装2，原因和解决方案如下：
机器用 $3.5/mo 512mem 最便宜的那档消费降级(512M 内存重启会拉垮弱鸡，服务已迁移到 oraclecloud)，出于 net/io 性能考虑就不使 docker 啦
内存问题，RAILS_ENV=production bundle exec rake mastodon:setup 这一步骤执行到 rails assets:precompile， 不管是在 docker 里跑还是直接运行都会报 swap 分区不足，找到两个方案来解决:
# create swapfile <https://linuxize.com/post/create-a-linux-swap-file/> $ sudo fallocate -l 2G /swapfile $ sudo chmod 600 /swapfile $ sudo mkswap /swapfile $ sudo swapon /swapfile # verify active $ sudo swapon --show # optional: low value is better for production $ sudo sysctl vm."><link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://y%C3%A1ny%C3%A0o.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://y%C3%A1ny%C3%A0o.com/css/main.css><script src=https://y%C3%A1ny%C3%A0o.com/js/feather.min.js></script>
<script src=https://y%C3%A1ny%C3%A0o.com/js/main.js></script></head><body><div class="container wrapper post"><div class=header><base href=https://y%C3%A1ny%C3%A0o.com/><h1 class=site-title><a href=https://y%C3%A1ny%C3%A0o.com/>yányào.com</a></h1><div class=site-description><nav class="nav social"><ul class=flat><a href=/index.xml title=RSS><i data-feather=rss></i></a><a href=/daydayup/ title=Bar><i data-feather=bar></i></a><a href=https://yankuiyi.com/ title=Radio><i data-feather=radio></i></a><a href=https://fouland.com/ title=Inbox><i data-feather=inbox></i></a><a href=https://at.yadanhe.com/ title=Wind><i data-feather=wind></i></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li></ul></nav></div><div class=post-header><h1 class=title>Mastodon</h1><div class=meta>Posted at &mdash; May 15, 2020</div></div><div class=markdown><p><code>Mastodon 长毛象</code><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> &ndash; 基于 rubyonrails/reactjs/nodejs 开发的分布式 &
去中心化 twiter clone。利用空闲时间在 aws lightsail 上开了个实例把服务跑了起来</p><p>一开始走了些弯路，因为选机房和省钱的缘故，重建了若干次操作系统，最后的选择是
tokyo+cloudflare，没错我又套了 cdn，实在是海外线路到北京联通不稳定</p><p>安装步骤没有使用 docker 而是参考文档从源码安装<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>，原因和解决方案如下：</p><ul><li><p><del>机器用 $3.5/mo 512mem 最便宜的那档消费降级</del>(512M 内存重启会拉垮弱鸡，服务已迁移到 oraclecloud)，出于 net/io 性能考虑就不使 docker 啦</p></li><li><p>内存问题，<code>RAILS_ENV=production bundle exec rake mastodon:setup</code>
这一步骤执行到 <code>rails assets:precompile</code>，
不管是在 docker 里跑还是直接运行都会报 swap 分区不足，找到两个方案来解决:</p></li></ul><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#586e75># create swapfile &lt;https://linuxize.com/post/create-a-linux-swap-file/&gt;</span>
</span></span><span style=display:flex><span>$ sudo fallocate -l 2G /swapfile
</span></span><span style=display:flex><span>$ sudo chmod <span style=color:#2aa198>600</span> /swapfile
</span></span><span style=display:flex><span>$ sudo mkswap /swapfile
</span></span><span style=display:flex><span>$ sudo swapon /swapfile
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># verify active</span>
</span></span><span style=display:flex><span>$ sudo swapon --show
</span></span><span style=display:flex><span><span style=color:#586e75># optional: low value is better for production</span>
</span></span><span style=display:flex><span>$ sudo sysctl vm.swappiness<span style=color:#719e07>=</span><span style=color:#2aa198>10</span>
</span></span></code></pre></div><h2 id=邮件配置>邮件配置</h2><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#586e75># By default the memory limit in Node. js is 512 mb, </span>
</span></span><span style=display:flex><span><span style=color:#586e75># use command —- max-old-space-size to increase the memory limit</span>
</span></span><span style=display:flex><span>$ <span style=color:#268bd2>NODE_OPTIONS</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#34;--max-old-space-size=4096&#34;</span> <span style=color:#268bd2>RAILS_ENV</span><span style=color:#719e07>=</span>production bundle <span style=color:#b58900>exec</span> rails assets:precompile
</span></span></code></pre></div><p>直接配置 localhost 发送邮件无效，先用 <a href=https://sendgrid.com/>sendgrid</a> 免费版顶着, 一天 100 封邮件目前够用</p><h2 id=迁移机器后重建-feed>迁移机器后重建 feed</h2><p>postgresql/redis 都换到了新机器, 之前因为 sidekiq 占用资源过多清理过 redis 数据, 相关 timeline 全都空了, 需要重建</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#268bd2>RAILS_ENV</span><span style=color:#719e07>=</span>production ./bin/tootctl feeds build
</span></span></code></pre></div><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://github.com/tootsuite/mastodon>https://github.com/tootsuite/mastodon</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://github.com/tootsuite/documentation/blob/master/content/en/admin/install.md>https://github.com/tootsuite/documentation/blob/master/content/en/admin/install.md</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=post-tags><nav class="nav tags"><ul class=flat><li><a href=/tags/mastodon>mastodon</a></li><li><a href=/tags/decentralized>decentralized</a></li></ul></nav></div></div><div class="footer wrapper"><nav class=nav><div><a href=https://github.com/vividvilla/ezhil>Ezhil theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></nav></div><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-LYFRPQF0H9","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script>feather.replace()</script></body></html>